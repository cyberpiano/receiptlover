<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Up - Receiptlover</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script type="text/javascript">
    (function () {
      emailjs.init({
        publicKey: "e45KQ0oGjEiozhqt2",
      });
      console.log("[EmailJS] Signup Page SDK Initialized");
    })();
  </script>

  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet" />

  <style>
    body {
      font-family: "Inter", sans-serif;
    }

    .font-poppins {
      font-family: "Poppins", sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gradient-text {
      background: linear-gradient(135deg,
          #667eea 0%,
          #764ba2 50%,
          #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slideIn 0.5s ease-out;
    }

    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }

    .input-with-icon {
      padding-left: 40px;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script src="email.js"></script>
</head>

<body
  class="bg-gradient-to-br from-slate-50 via-purple-50 to-blue-50 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-md border border-purple-100 slide-in">
    <!-- Back Button -->
    <div class="flex justify-start items-center mb-6">
      <a href="index.html"
        class="text-sm text-slate-500 hover:text-purple-600 inline-flex items-center gap-2 transition font-medium">
        <i class="fa-solid fa-arrow-left"></i> Back to Home
      </a>
    </div>

    <!-- Header with Brand -->
    <div class="text-center mb-8">
      <div class="flex items-center justify-center gap-3 mb-4">
        <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center text-white shadow-lg">
          <i class="fa-solid fa-heart text-xl"></i>
        </div>
        <h1 class="text-3xl font-black font-poppins gradient-text">
          Receiptlover
        </h1>
      </div>
      <h2 class="text-2xl font-bold text-slate-800 mb-2">
        Create Your Account
      </h2>
      <p class="text-slate-500">
        <i class="fa-solid fa-gift text-purple-500 mr-1"></i>
        Start your
        <span class="font-semibold text-purple-600">3-day free trial</span>
      </p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage"
      class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-xl text-sm mb-4 text-center flex items-center justify-center gap-2">
      <i class="fa-solid fa-circle-exclamation"></i>
      <span id="errorText"></span>
    </div>

    <!-- Signup Form -->
    <form id="signupForm" class="space-y-4">
      <!-- Name Fields -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-semibold text-slate-600 mb-2">
            <i class="fa-solid fa-user text-purple-500 mr-1"></i>
            First Name
          </label>
          <div class="relative">
            <input type="text" id="firstName" required
              class="w-full p-3 border-2 border-slate-200 rounded-xl focus:outline-none focus:border-purple-500 transition bg-slate-50 focus:bg-white"
              placeholder="Enter first name" />
          </div>
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-600 mb-2">
            <i class="fa-solid fa-user text-purple-500 mr-1"></i>
            Last Name
          </label>
          <div class="relative">
            <input type="text" id="lastName" required
              class="w-full p-3 border-2 border-slate-200 rounded-xl focus:outline-none focus:border-purple-500 transition bg-slate-50 focus:bg-white"
              placeholder="Enter last name" />
          </div>
        </div>
      </div>

      <!-- Email Field -->
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-2">
          <i class="fa-solid fa-envelope text-purple-500 mr-1"></i>
          Email Address
        </label>
        <div class="relative">
          <input type="email" id="email" required
            class="w-full p-3 border-2 border-slate-200 rounded-xl focus:outline-none focus:border-purple-500 transition bg-slate-50 focus:bg-white"
            placeholder="you@example.com" />
        </div>
      </div>

      <!-- Password Field -->
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-2">
          <i class="fa-solid fa-lock text-purple-500 mr-1"></i>
          Password
        </label>
        <div class="relative">
          <input type="password" id="password" required
            class="w-full p-3 border-2 border-slate-200 rounded-xl focus:outline-none focus:border-purple-500 transition bg-slate-50 focus:bg-white pr-12"
            placeholder="Enter your password" />
          <button type="button" aria-label="Toggle password visibility" onclick="togglePassword('password', this)"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-purple-600 transition">
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
      </div>

      <!-- Confirm Password Field -->
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-2">
          <i class="fa-solid fa-lock-open text-purple-500 mr-1"></i>
          Confirm Password
        </label>
        <div class="relative">
          <input type="password" id="confirmPassword" required
            class="w-full p-3 border-2 border-slate-200 rounded-xl focus:outline-none focus:border-purple-500 transition bg-slate-50 focus:bg-white pr-12"
            placeholder="Confirm your password" />
          <button type="button" aria-label="Toggle confirm password visibility"
            onclick="togglePassword('confirmPassword', this)"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-purple-600 transition">
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
      </div>

      <!-- Submit Button -->
      <button id="signupBtn" type="submit"
        class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-2xl transition shadow-lg shadow-purple-300 hover:scale-105 mt-6 flex items-center justify-center gap-2">
        <i class="fa-solid fa-rocket"></i>
        Start 3-Day Free Trial
      </button>

      <!-- Trust Badges -->
      <div class="flex items-center justify-center gap-4 text-xs text-slate-500 mt-4">
        <div class="flex items-center gap-1">
          <i class="fa-solid fa-check-circle text-green-500"></i>
          <span>No credit card</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="fa-solid fa-shield-halved text-blue-500"></i>
          <span>Secure signup</span>
        </div>
      </div>
    </form>

    <!-- Login Link -->
    <p class="text-center text-sm text-slate-500 mt-6">
      Already have an account?
      <a href="login.html" class="text-purple-600 font-bold hover:underline">
        Log In <i class="fa-solid fa-arrow-right text-xs"></i>
      </a>
    </p>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDnN7AODVubqLmnOniyjQkSWGvBJJ2kMQU",
      authDomain: "invoiceapp-3fe51.firebaseapp.com",
      projectId: "invoiceapp-3fe51",
      storageBucket: "invoiceapp-3fe51.firebasestorage.app",
      messagingSenderId: "178955208220",
      appId: "1:178955208220:web:128a713add6c992f9981d9",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document
      .getElementById("signupForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const signupBtn = document.getElementById("signupBtn");
        const firstName = document.getElementById("firstName").value;
        const lastName = document.getElementById("lastName").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const errorDiv = document.getElementById("errorMessage");
        const errorText = document.getElementById("errorText");

        if (password !== confirmPassword) {
          errorText.innerText = "Passwords do not match.";
          errorDiv.classList.remove("hidden");
          return;
        }

        try {
          errorDiv.classList.add("hidden");
          // Show loading state
          if (signupBtn) {
            signupBtn.disabled = true;
            signupBtn.innerHTML =
              '<span class="flex items-center justify-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> Creating account...</span>';
          }

          // Device Trial Check
          const hasUsedTrial = localStorage.getItem("deviceTrialUsed");
          let trialDays = 3;

          if (hasUsedTrial === "true") {
            trialDays = 0;
          }

          // 1. Create User
          const userCredential = await auth.createUserWithEmailAndPassword(
            email,
            password,
          );
          const user = userCredential.user;
          // Send signup email
          if (window.sendSignupEmail)
            window.sendSignupEmail(email, firstName);

          // 2. Determine Expiry
          const expiryDate = new Date();
          if (trialDays > 0) {
            expiryDate.setDate(expiryDate.getDate() + 3);
            localStorage.setItem("deviceTrialUsed", "true");
            localStorage.setItem("currentUserEmail", email);
            localStorage.setItem(
              "currentUserTrialEnd",
              expiryDate.toISOString(),
            );
          } else {
            localStorage.removeItem("currentUserTrialEnd");
            localStorage.setItem("currentUserEmail", email);
          }

          const status = trialDays > 0 ? "trial" : "inactive";

          // 3. Create User Doc
          await db.collection("users").doc(user.uid).set({
            firstName: firstName,
            lastName: lastName,
            email: email,
            subscriptionStatus: status,
            subscriptionExpiry: expiryDate,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          // 4. Redirect
          if (trialDays > 0) {
            if (signupBtn) {
              signupBtn.innerHTML =
                '<i class="fa-solid fa-check-circle"></i> Success! Redirecting...';
            }
            setTimeout(() => {
              window.location.href = "dashboard.html";
            }, 900);
          } else {
            if (signupBtn) {
              signupBtn.innerHTML =
                '<i class="fa-solid fa-check-circle"></i> Success! Redirecting...';
            }
            setTimeout(() => {
              alert(
                "This device has already used a free trial. Please subscribe to continue.",
              );
              window.location.href = "payment.html";
            }, 900);
          }
        } catch (error) {
          console.error(error);
          errorText.innerText = error.message;
          errorDiv.classList.remove("hidden");
          if (signupBtn) {
            signupBtn.disabled = false;
            signupBtn.innerHTML =
              '<i class="fa-solid fa-rocket"></i> Start 3-Day Free Trial';
          }
        }
      });

    // Password toggle helper
    function togglePassword(fieldId, btn) {
      const input = document.getElementById(fieldId);
      const icon = btn.querySelector("i");
      if (!input) return;
      if (input.type === "password") {
        input.type = "text";
        if (icon) {
          icon.className = "fa-solid fa-eye-slash";
        }
      } else {
        input.type = "password";
        if (icon) {
          icon.className = "fa-solid fa-eye";
        }
      }
    }
  </script>
</body>

</html>