<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Login - Receiptlover</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }

    .font-poppins {
      font-family: "Poppins", sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gradient-text {
      background: linear-gradient(135deg,
          #667eea 0%,
          #764ba2 50%,
          #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slideIn 0.5s ease-out;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body
  class="bg-gradient-to-br from-slate-50 via-purple-50 to-blue-50 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-md border border-purple-100 slide-in">
    <!-- Back Button -->
    <div class="flex justify-start items-center mb-6">
      <a href="index.html"
        class="text-sm text-slate-500 hover:text-purple-600 inline-flex items-center gap-2 transition font-medium">
        <i class="fa-solid fa-arrow-left"></i> Back to Home
      </a>
    </div>

    <!-- Header with Brand & Shield -->
    <div class="text-center mb-8">
      <div class="flex items-center justify-center gap-3 mb-4">
        <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center text-white shadow-lg">
          <i class="fa-solid fa-shield-halved text-xl"></i>
        </div>
        <div>
          <h1 class="text-3xl font-black font-poppins gradient-text">
            Receiptlover
          </h1>
          <p class="text-xs text-slate-500">Admin Portal</p>
        </div>
      </div>
      <h2 class="text-2xl font-bold text-slate-800 mb-2">Admin Access</h2>
      <p class="text-slate-500">
        <i class="fa-solid fa-lock text-purple-500 mr-1"></i>
        Sign in with your admin credentials
      </p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage"
      class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-xl text-sm mb-4 text-center flex items-center justify-center gap-2">
      <i class="fa-solid fa-circle-exclamation"></i>
      <span id="errorText"></span>
    </div>

    <!-- Login Form -->
    <form id="loginForm" class="space-y-4">
      <!-- Email Field -->
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-2">
          <i class="fa-solid fa-envelope text-purple-500 mr-1"></i>
          Admin Email Address
        </label>
        <div class="relative">
          <input type="email" id="email" required
            class="w-full p-3 border-2 border-slate-200 rounded-xl focus:outline-none focus:border-purple-500 transition bg-slate-50 focus:bg-white"
            placeholder="admin@example.com" />
        </div>
      </div>

      <!-- Password Field -->
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-2">
          <i class="fa-solid fa-lock text-purple-500 mr-1"></i>
          Password
        </label>
        <div class="relative">
          <input type="password" id="password" required
            class="w-full p-3 border-2 border-slate-200 rounded-xl focus:outline-none focus:border-purple-500 transition bg-slate-50 focus:bg-white pr-12"
            placeholder="Enter your password" />
          <button type="button" onclick="togglePassword('password', this)" aria-label="Toggle password visibility"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-purple-600 transition">
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
      </div>

      <!-- Forgot Password Link -->
      <div class="text-right">
        <button type="button" onclick="openForgotModal()"
          class="text-sm text-purple-600 hover:text-purple-700 font-semibold hover:underline">
          Forgot password?
        </button>
      </div>

      <!-- Submit Button -->
      <button id="loginBtn" type="submit"
        class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-2xl transition shadow-lg shadow-purple-300 hover:scale-105 flex items-center justify-center gap-2">
        <i class="fa-solid fa-shield-halved"></i>
        Access Admin Dashboard
      </button>

      <!-- Trust Badge -->
      <div class="flex items-center justify-center gap-2 text-xs text-slate-500 mt-4">
        <i class="fa-solid fa-shield-halved text-green-500"></i>
        <span>Secure login with encryption</span>
      </div>
    </form>

    <!-- Restricted Access Info -->
    <div class="bg-purple-50 border border-purple-200 p-4 rounded-xl mt-6">
      <p class="text-xs text-slate-600 mb-2">
        <i class="fa-solid fa-info-circle text-purple-600 mr-2"></i>
        <strong>Restricted Access</strong>
      </p>
      <p class="text-xs text-slate-600">
        This portal is for authorized administrators only. Unauthorized access
        attempts are logged.
      </p>
    </div>
  </div>

  <script>
    // 1. Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDnN7AODVubqLmnOniyjQkSWGvBJJ2kMQU",
      authDomain: "invoiceapp-3fe51.firebaseapp.com",
      projectId: "invoiceapp-3fe51",
      storageBucket: "invoiceapp-3fe51.firebasestorage.app",
      messagingSenderId: "178955208220",
      appId: "1:178955208220:web:128a713add6c992f9981d9",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Admin email(s)
    const ADMIN_EMAILS = ["emmanuelfiati32@gmail.com"];

    /**
     * Main Admin Login Handler
     */
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const loginBtn = document.getElementById("loginBtn");
      const email = document.getElementById("email").value.trim().toLowerCase();
      const password = document.getElementById("password").value;
      const errorDiv = document.getElementById("errorMessage");
      const errorText = document.getElementById("errorText");

      // UI Reset
      errorDiv.classList.add("hidden");
      setLoadingState(true);

      const attemptRef = db.collection("admin_lockouts").doc(email);

      try {
        // --- SECURITY CHECK: Check for Lockout ---
        const attemptDoc = await attemptRef.get();
        if (attemptDoc.exists && attemptDoc.data().count >= 5) {
          errorText.innerText = "Access locked. Too many failed attempts.";
          errorDiv.classList.remove("hidden");
          setLoadingState(false);
          return;
        }

        // --- FIREBASE AUTHENTICATION ---
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // --- ADMIN AUTHORIZATION CHECK ---
        if (!ADMIN_EMAILS.includes(user.email)) {
          await auth.signOut();
          // Throw a custom error to trigger the catch block for non-admins
          throw { code: "auth/unauthorized-admin" };
        }

        // SUCCESS: Clear lockout strikes and redirect
        await attemptRef.delete();
        loginBtn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Access Granted! Redirecting...';
        setTimeout(() => (window.location.href = "admin-dashboard.html"), 700);

      } catch (error) {
        console.error("Login Error:", error.code);

        // --- INCREMENT STRIKES ON FAILURE ---
        const doc = await attemptRef.get();
        let count = (doc.exists ? doc.data().count : 0) + 1;
        await attemptRef.set({
          count: count,
          lastAttempt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // --- NON-VERBOSE ERROR MESSAGES ---
        let simpleMessage = "Invalid email or password.";

        if (error.code === "auth/unauthorized-admin") {
          simpleMessage = "Access denied. Unauthorized administrator.";
        } else if (error.code === "auth/too-many-requests") {
          simpleMessage = "Too many attempts. Please try again later.";
        }

        errorText.innerText = simpleMessage;
        errorDiv.classList.remove("hidden");
        setLoadingState(false);
      }
    });

    /**
     * UI Helpers
     */
    function setLoadingState(isLoading) {
      const btn = document.getElementById("loginBtn");
      if (isLoading) {
        btn.disabled = true;
        btn.innerHTML = '<span class="flex items-center justify-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> Verifying...</span>';
      } else {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-shield-halved"></i> Access Admin Dashboard';
      }
    }

    function togglePassword(fieldId, btn) {
      const input = document.getElementById(fieldId);
      const icon = btn.querySelector("i");
      if (!input) return;
      if (input.type === "password") {
        input.type = "text";
        icon.className = "fa-solid fa-eye-slash";
      } else {
        input.type = "password";
        icon.className = "fa-solid fa-eye";
      }
    }

    /**
     * Forgot Password Logic
     */
    function openForgotModal() {
      if (document.getElementById("forgotModal")) {
        document.getElementById("forgotModal").classList.remove("hidden");
        return;
      }
      const overlay = document.createElement("div");
      overlay.id = "forgotModal";
      overlay.className = "fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4";
      overlay.innerHTML = `
      <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl border border-purple-100">
        <div class="text-center mb-6">
          <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl">
            <i class="fa-solid fa-key"></i>
          </div>
          <h3 class="text-2xl font-bold font-poppins mb-2">Reset Password</h3>
          <p class="text-sm text-slate-500">Enter your admin email to receive instructions.</p>
        </div>
        <input id="resetEmail" type="email" placeholder="admin@example.com" class="w-full p-3 border-2 border-slate-200 rounded-xl mb-4 focus:outline-none focus:border-purple-500 transition" />
        <div class="flex gap-3 justify-end">
          <button id="cancelResetBtn" class="px-6 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 transition font-semibold">Cancel</button>
          <button id="sendResetBtn" class="px-6 py-3 rounded-xl gradient-bg text-white font-bold hover:shadow-xl transition">Send Email</button>
        </div>
        <p id="resetMessage" class="text-sm mt-4 text-center font-semibold"></p>
      </div>`;
      document.body.appendChild(overlay);

      const input = document.getElementById("resetEmail");
      if (input) input.value = document.getElementById("email")?.value || "";

      document.getElementById("cancelResetBtn").addEventListener("click", closeForgotModal);
      document.getElementById("sendResetBtn").addEventListener("click", sendResetEmail);
    }

    function closeForgotModal() {
      const el = document.getElementById("forgotModal");
      if (el) el.classList.add("hidden");
    }

    async function sendResetEmail() {
      const emailEl = document.getElementById("resetEmail");
      const msg = document.getElementById("resetMessage");
      const sendBtn = document.getElementById("sendResetBtn");
      const email = emailEl.value.trim();

      if (!email) {
        msg.innerText = "Please enter your email address.";
        msg.style.color = "#dc2626";
        return;
      }

      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Sending...';

      try {
        await auth.sendPasswordResetEmail(email);
        msg.innerText = "âœ“ Reset email sent. Check your inbox.";
        msg.style.color = "#16a34a";
        setTimeout(closeForgotModal, 2500);
      } catch (err) {
        msg.innerText = "Error sending reset email.";
        msg.style.color = "#dc2626";
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = "Send Email";
      }
    }
  </script>
</body>

</html>